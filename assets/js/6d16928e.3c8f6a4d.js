"use strict";(self.webpackChunkkratix_docs=self.webpackChunkkratix_docs||[]).push([[8271],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(n),d=i,k=c["".concat(l,".").concat(d)]||c[d]||m[d]||r;return n?a.createElement(k,s(s({ref:t},u),{},{components:n})):a.createElement(k,s({ref:t},u))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=c;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,s[1]=o;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>s});var a=n(7294),i=n(6010);const r="tabItem_Ymn6";function s(e){let{children:t,hidden:n,className:s}=e;return a.createElement("div",{role:"tabpanel",className:(0,i.Z)(r,s),hidden:n},t)}},5488:(e,t,n)=>{n.d(t,{Z:()=>d});var a=n(7462),i=n(7294),r=n(6010),s=n(2389),o=n(7392),l=n(7094),p=n(2466);const u="tabList__CuJ",m="tabItem_LNqP";function c(e){var t;const{lazy:n,block:s,defaultValue:c,values:d,groupId:k,className:h}=e,g=i.Children.map(e.children,(e=>{if((0,i.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),y=d??g.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),f=(0,o.l)(y,((e,t)=>e.value===t.value));if(f.length>0)throw new Error(`Docusaurus error: Duplicate values "${f.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const w=null===c?c:c??(null==(t=g.find((e=>e.props.default)))?void 0:t.props.value)??g[0].props.value;if(null!==w&&!y.some((e=>e.value===w)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${w}" but none of its children has the corresponding value. Available values are: ${y.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:N,setTabGroupChoices:b}=(0,l.U)(),[v,x]=(0,i.useState)(w),C=[],{blockElementScrollPositionUntilNextRender:P}=(0,p.o5)();if(null!=k){const e=N[k];null!=e&&e!==v&&y.some((t=>t.value===e))&&x(e)}const j=e=>{const t=e.currentTarget,n=C.indexOf(t),a=y[n].value;a!==v&&(P(t),x(a),null!=k&&b(k,String(a)))},R=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{const t=C.indexOf(e.currentTarget)+1;n=C[t]??C[0];break}case"ArrowLeft":{const t=C.indexOf(e.currentTarget)-1;n=C[t]??C[C.length-1];break}}null==(t=n)||t.focus()};return i.createElement("div",{className:(0,r.Z)("tabs-container",u)},i.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":s},h)},y.map((e=>{let{value:t,label:n,attributes:s}=e;return i.createElement("li",(0,a.Z)({role:"tab",tabIndex:v===t?0:-1,"aria-selected":v===t,key:t,ref:e=>C.push(e),onKeyDown:R,onFocus:j,onClick:j},s,{className:(0,r.Z)("tabs__item",m,null==s?void 0:s.className,{"tabs__item--active":v===t})}),n??t)}))),n?(0,i.cloneElement)(g.filter((e=>e.props.value===v))[0],{className:"margin-top--md"}):i.createElement("div",{className:"margin-top--md"},g.map(((e,t)=>(0,i.cloneElement)(e,{key:t,hidden:e.props.value!==v})))))}function d(e){const t=(0,s.Z)();return i.createElement(c,(0,a.Z)({key:String(t)},e))}},6092:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>s,metadata:()=>l,toc:()=>u});var a=n(7462),i=(n(7294),n(3905)),r=n(4996);n(5488),n(5162);const s={description:"Writing a Jenkins Promise",title:"Part 2",id:"writing-a-jenkins-promise",slug:"/events/2022-kcduk/writing-a-jenkins-promise"},o="Writing a Jenkins Promise",l={unversionedId:"events/kcduk/writing-a-jenkins-promise",id:"events/kcduk/writing-a-jenkins-promise",title:"Part 2",description:"Writing a Jenkins Promise",source:"@site/docs/events/2022-kcduk/02-writing-a-jenkins-promise.md",sourceDirName:"events/2022-kcduk",slug:"/events/2022-kcduk/writing-a-jenkins-promise",permalink:"/docs/events/2022-kcduk/writing-a-jenkins-promise",draft:!1,editUrl:"https://github.com/syntasso/kratix-docs/tree/main/docs/events/2022-kcduk/02-writing-a-jenkins-promise.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{description:"Writing a Jenkins Promise",title:"Part 2",id:"writing-a-jenkins-promise",slug:"/events/2022-kcduk/writing-a-jenkins-promise"},sidebar:"events",previous:{title:"Part 1",permalink:"/docs/events/2022-kcduk/using-multiple-promises"}},p={},u=[{value:"What&#39;s inside a Kratix Promise?",id:"whats-inside-a-kratix-promise",level:2},{value:"A Promise consists of three parts:",id:"a-promise-consists-of-three-parts",level:3},{value:"Basics of getting a promised instance to your users",id:"basics-of-getting-a-promised-instance-to-your-users",level:2},{value:"A Kratix Promise to deliver Jenkins",id:"a-kratix-promise-to-deliver-jenkins",level:2},{value:"Writing your own Kratix Promise",id:"writing-your-own-kratix-promise",level:2},{value:"Directory setup",id:"directory-setup",level:3},{value:"Define your Promise API",id:"promise-api",level:3},{value:"Define your <code>workerClusterResources</code> in your Promise definition",id:"worker-cluster-resources",level:3},{value:"Create your Resource Request Pipeline",id:"create-pipeline",level:3},{value:"Build a simple request pipeline",id:"pipeline-script",level:4},{value:"Test your pipeline image",id:"test-image",level:3},{value:"Build your pipeline image",id:"build-image",level:3},{value:"Install your Promise",id:"install-promise",level:3},{value:"Create and submit a Kratix Resource Request",id:"create-resource-request",level:3},{value:"Use your Jenkins instance",id:"use-your-jenkins-instance",level:3},{value:"Review of a Kratix Promise parts (in detail)",id:"promise-review",level:3},{value:"<code>xaasCrd</code>",id:"xaascrd",level:4},{value:"<code>workerClusterResources</code>",id:"workerclusterresources",level:4},{value:"<code>xaasRequestPipeline</code>",id:"xaasrequestpipeline",level:4},{value:"Recap",id:"summary",level:2},{value:"Tearing it all down",id:"teardown",level:2}],m={toc:u};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"writing-a-jenkins-promise"},"Writing a Jenkins Promise"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"In this tutorial, you will")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#whats-inside-a-kratix-promise"},"learn more about what's inside a Kratix Promise")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#writing-your-own-kratix-promise"},"write and install your own Jenkins Promise"))),(0,i.kt)("h2",{id:"whats-inside-a-kratix-promise"},"What's inside a Kratix Promise?"),(0,i.kt)("p",null,"You've ",(0,i.kt)("a",{parentName:"p",href:"using-multiple-promises"},"installed Kratix and a couple sample Promises"),". Now you'll create a Promise from scratch."),(0,i.kt)("p",null,"A Kratix Promise is a YAML document that defines a contract between the platform and its users. It is what allows platforms to be built incrementally."),(0,i.kt)("h3",{id:"a-promise-consists-of-three-parts"},"A Promise consists of three parts:"),(0,i.kt)("img",{align:"right",src:(0,r.Z)("/img/docs/base-promise-structure.png"),alt:"Kratix logo"}),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"workerClusterResources"),": a collection of Kubernetes resources that enable the creation of an instance and will be pre-installed in the worker clusters."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"xaasCrd"),": the CRD that an application developer uses to request an instance of the Kratix Promise from the platform cluster."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"xaasRequestPipeline"),": an ordered list of docker containers that result in the creation an instance of the promised service on a worker cluster.")),(0,i.kt)("h2",{id:"basics-of-getting-a-promised-instance-to-your-users"},"Basics of getting a promised instance to your users"),(0,i.kt)("p",null,"At a very high level"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"You talk to users of your platform to find out what they're using and what they need."),(0,i.kt)("li",{parentName:"ul"},"You write a Kratix Promise for the service",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"In ",(0,i.kt)("inlineCode",{parentName:"li"},"workerClusterResources"),", you define what baseline resources are needed to deliver this capability."),(0,i.kt)("li",{parentName:"ul"},"In ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasCrd"),", you list what your users can configure in their request."),(0,i.kt)("li",{parentName:"ul"},"In ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasRequestPipeline"),", you list Docker images that will take the user's request and decorate it with configuration that you or the business require."))),(0,i.kt)("li",{parentName:"ul"},"You install the Promise on your platform cluster, where Kratix is installed."),(0,i.kt)("li",{parentName:"ul"},"Your user wants an instance of the Promise."),(0,i.kt)("li",{parentName:"ul"},"Your user submit a Kratix Resource Request that lists what they want and how they want it, and this complies with the ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasCrd")," (more details on this request later)."),(0,i.kt)("li",{parentName:"ul"},"Kratix fires off the request pipeline that you defined in ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasRequestPipeline")," and passes the Resource Request as an input."),(0,i.kt)("li",{parentName:"ul"},"The pipeline outputs valid Kubernetes documents that say what the user wants and what the business wants for that Promise instance."),(0,i.kt)("li",{parentName:"ul"},"The worker cluster has what it needs based on the ",(0,i.kt)("inlineCode",{parentName:"li"},"workerClusterResources")," and is ready to create the instance when the request comes through.")),(0,i.kt)("h2",{id:"a-kratix-promise-to-deliver-jenkins"},"A Kratix Promise to deliver Jenkins"),(0,i.kt)("p",null,"In the last section, you enabled teams to deliver their application onto Knative with a Postgres datastore. Now your team wants to deploy changes to this application using a Jenkins CI/CD pipeline."),(0,i.kt)("p",null,"Imagine this is the third request to your platform team for a Jenkins instance. You decide three times is too many times to manually set up Jenkins."),(0,i.kt)("p",null,"Now you decide to write a Jenkins Promise and install it on your platform so that your teams get Jenkins","\u2014","and you get time back for more valuable work."),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"writing-your-own-kratix-promise"},"Writing your own Kratix Promise"),(0,i.kt)("p",null,"This guide will follow the steps below:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Define Promise")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#directory-setup"},"Directory setup"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Promise definition: workerClusterResources")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#worker-cluster-resources"},"Define your ",(0,i.kt)("inlineCode",{parentName:"a"},"workerClusterResources")," in your Promise definition"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Promise definition: xaasCrd")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#promise-api"},"X as-a-Service Custom Resource Definition: define your Promise API"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Promise definition: xaasRequestPipeline")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#pipeline-script"},"Build a simple request pipeline")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#test-image"},"Test your container image")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#build-image"},"Build your pipeline image"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Test Promise")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#install-promise"},"Install your Promise")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#create-resource-request"},"Create and submit a Kratix Resource Request")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#promise-review"},"Review of a Kratix Promise parts (in detail)")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#summary"},"Summary")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"#teardown"},"Tear down your environment"))),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"directory-setup"},"Directory setup"),(0,i.kt)("p",null,"To begin writing a Promise you will need a basic directory structure to work in. You can use our promise template to get started."),(0,i.kt)("p",null,"Run the following commands in a working directory of your choosing."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/syntasso/promise-template.git\ncd promise-template\n")),(0,i.kt)("h3",{id:"promise-api"},"Define your Promise API"),(0,i.kt)("p",null,"You've decided you want to create a Jenkins promise available to your users. To do this you need to setup the ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml")," file. First lets\nsetup the name of the Promise. Update the ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml")," so that the name is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"Jenkins"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="xaasCrd in promise.yaml"',jsx:!0,title:'"xaasCrd',in:!0,'promise.yaml"':!0},"apiVersion: platform.kratix.io/v1alpha1\nkind: Promise\nmetadata:\n  name: jenkins\nspec:\n  # workerClusterResources:\n  # xaasCrd:\n  # xaasRequestPipeline:\n")),(0,i.kt)("p",null,"Now you can start working your way through the 3 components of the promise, the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasRequestPipeline"),"."),(0,i.kt)("p",null,"For the purpose of this tutorial, you will create an API that accepts a single ",(0,i.kt)("inlineCode",{parentName:"p"},"string")," parameter called ",(0,i.kt)("inlineCode",{parentName:"p"},"name"),". In real world scenarios, the API can be as simple or as complex you design it to be. The Promise API is defined within the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," of your Promise YAML."),(0,i.kt)("p",null,"Replace the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," field in ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml")," with the complete field details below. Ensure the indentation is correct (",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," is nested under ",(0,i.kt)("inlineCode",{parentName:"p"},"spec"),")."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="xaasCrd in promise.yaml"',jsx:!0,title:'"xaasCrd',in:!0,'promise.yaml"':!0},"  xaasCrd:\n    apiVersion: apiextensions.k8s.io/v1\n    kind: CustomResourceDefinition\n    metadata:\n      name: jenkins.example.promise.syntasso.io\n    spec:\n      group: example.promise.syntasso.io\n      scope: Namespaced\n      names:\n        plural: jenkins\n        singular: jenkins\n        kind: jenkins\n      versions:\n      - name: v1\n        served: true\n        storage: true\n        schema:\n          openAPIV3Schema:\n            type: object\n            properties:\n              spec:\n                type: object\n                properties:\n                  name:\n                    type: string\n")),(0,i.kt)("p",null,"You have now defined the as-a-Service API."),(0,i.kt)("h3",{id:"worker-cluster-resources"},"Define your ",(0,i.kt)("inlineCode",{parentName:"h3"},"workerClusterResources")," in your Promise definition"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," describes everything required to be running on the cluster before a users request is applied. Kratix applies this content on all registered worker clusters."),(0,i.kt)("p",null,"For this Promise, the ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," needs to contain the Jenkins Operator. One option to deploy the Jenkins Operator is to use a helm chart. Flux is already in use on the worker clusters and provides an easy way to reference and configure Helm charts. In this case, you will use a ",(0,i.kt)("inlineCode",{parentName:"p"},"HelmRepository")," resource to reference the public Jenkins Operator Helm chart. Then you will use a ",(0,i.kt)("inlineCode",{parentName:"p"},"Helm Release")," resource to deploy an instance of that chart including any custom values."),(0,i.kt)("p",null,"Replace the ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," field in the ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml")," with the complete field details below. Ensure the indentation is correct (",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," is nested under ",(0,i.kt)("inlineCode",{parentName:"p"},"spec"),")."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="xaasCrd in promise.yaml"',jsx:!0,title:'"xaasCrd',in:!0,'promise.yaml"':!0},"  workerClusterResources:\n  - apiVersion: source.toolkit.fluxcd.io/v1beta1\n    kind: HelmRepository\n    metadata:\n      name: jenkins-operator-repo\n    spec:\n      interval: 5m\n      url: https://raw.githubusercontent.com/jenkinsci/kubernetes-operator/master/chart\n  - apiVersion: helm.toolkit.fluxcd.io/v2beta1\n    kind: HelmRelease\n    metadata:\n      name: jenkins-operator\n    spec:\n      interval: 5m\n      values:\n        jenkins:\n          enabled: false\n      chart:\n        spec:\n          chart: jenkins-operator\n          sourceRef:\n            kind: HelmRepository\n            name: jenkins-operator-repo\n          version: 0.6.2\n")),(0,i.kt)("h3",{id:"create-pipeline"},"Create your Resource Request Pipeline"),(0,i.kt)("p",null,"You've now completed setting up the ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," which deploys the Jenkins Operator to all worker clusters. You also have set up the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," which requests values from your users to customise an instance request. The Kratix pipeline is where you can define business logic generate a Jenkins instance request using the custom values."),(0,i.kt)("p",null,"The Jenkins Operator defines a Jenkins custom resources which is used to request an instance where the spec is any custom configuration. Below is an example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: jenkins.io/v1alpha2\nkind: Jenkins\nmetadata:\n  name: example-jenkins\n  namespace: default\nspec:\n  jenkinsAPISettings:\n    authorizationStrategy: createUser\n  master:\n    basePlugins:\n    - name: kubernetes\n      version: "1.31.3"\n  ...\n')),(0,i.kt)("p",null,"You need to setup a pipeline to produce a Jenkins request that meets your business and user requirements."),(0,i.kt)("h4",{id:"pipeline-script"},"Build a simple request pipeline"),(0,i.kt)("p",null,"Kratix takes no opinion on the tooling used within a pipeline. Kratix will pass a set of resources to the pipeline, and expect back a set of resources. What happens within the pipeline, and what tooling is used, is a decision left entirely to you."),(0,i.kt)("p",null,"For this example, you're taking a name from the Kratix Resource Request for an instance and passing it to the Jenkins custom resource output."),(0,i.kt)("p",null,"To keep this transformation simple, you'll use ",(0,i.kt)("inlineCode",{parentName:"p"},"yq"),", a CLI tool to manipulate yaml."),(0,i.kt)("p",null,"Inside the ",(0,i.kt)("inlineCode",{parentName:"p"},"request-pipeline-image/")," directory you will find a the following files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Dockerfile\nasset.yaml\nexecute-pipeline.sh\n")),(0,i.kt)("p",null,"The Dockerfile has already been setup to contain ",(0,i.kt)("inlineCode",{parentName:"p"},"yq")," and to execute the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," when run. You need to update the pipeline so that it outputs the desired Jenkins custom resource."),(0,i.kt)("p",null,"First lets add an asset file containing an example Jenkins custom resource, we can then update the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," script to manipulate this file to have the desired name."),(0,i.kt)("p",null,"Update the contents of ",(0,i.kt)("inlineCode",{parentName:"p"},"asset.yaml")," to contain the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="request-pipeline-image/asset.yaml"',jsx:!0,title:'"request-pipeline-image/asset.yaml"'},'apiVersion: jenkins.io/v1alpha2\nkind: Jenkins\nmetadata:\n  name: example\n  namespace: default\nspec:\n  configurationAsCode:\n    configurations: []\n    secret:\n      name: ""\n  groovyScripts:\n    configurations: []\n    secret:\n      name: ""\n  jenkinsAPISettings:\n    authorizationStrategy: createUser\n  master:\n    basePlugins:\n    - name: kubernetes\n      version: "1.31.3"\n    - name: workflow-job\n      version: "1180.v04c4e75dce43"\n    - name: workflow-aggregator\n      version: "2.7"\n    - name: git\n      version: "4.11.0"\n    - name: job-dsl\n      version: "1.79"\n    - name: configuration-as-code\n      version: "1414.v878271fc496f"\n    - name: kubernetes-credentials-provider\n      version: "0.20"\n    disableCSRFProtection: false\n    containers:\n      - name: jenkins-master\n        image: jenkins/jenkins:2.332.2-jdk17\n        imagePullPolicy: Always\n        command:\n          - bash\n          - -c\n          - /var/jenkins/scripts/init.sh && /usr/bin/tini -s -- /usr/local/bin/jenkins.sh\n        env:\n          - name: JAVA_OPTS\n            value: -Xmx125m -XX:MinRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0 -Djenkins.install.runSetupWizard=false -Djava.awt.headless=true\n        livenessProbe:\n          failureThreshold: 12\n          httpGet:\n            path: /login\n            port: http\n            scheme: HTTP\n          initialDelaySeconds: 100\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 5\n        readinessProbe:\n          failureThreshold: 10\n          httpGet:\n            path: /login\n            port: http\n            scheme: HTTP\n          initialDelaySeconds: 80\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        resources:\n          limits:\n            cpu: 1500m\n            memory: 3Gi\n          requests:\n            cpu: "1"\n            memory: 500Mi\n')),(0,i.kt)("p",null,"Inside the Dockerfile we already have this ",(0,i.kt)("inlineCode",{parentName:"p"},"asset.yaml")," added, meaning that it can be accessed by the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," script. Lets now update the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," script to set the desired name."),(0,i.kt)("p",null,"Kratix will provide the user's resource request (the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," instance) as an input to the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," script by placing it at ",(0,i.kt)("inlineCode",{parentName:"p"},"/input/object.yaml"),". The script needs to output the desired resources to ",(0,i.kt)("inlineCode",{parentName:"p"},"/output/"),"."),(0,i.kt)("p",null,"Update the ",(0,i.kt)("inlineCode",{parentName:"p"},"execute-pipeline.sh")," script to contain the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'jsx title="request-pipeline-image/execute-pipeline.sh"',jsx:!0,title:'"request-pipeline-image/execute-pipeline.sh"'},"#!/bin/sh\n\nset -x\n\n# Read users input from the object\nexport NAME=$(yq eval '.spec.name' /input/object.yaml)\n\n# Replace defaults with user provided values and place the contennts in /output/\ncat asset.yaml |  \\\n  yq eval '.metadata.name = env(NAME)' - \\\n  > /output/jenkins_instance.yaml\n\n")),(0,i.kt)("p",null,"You've successfully wired up the pipeline to create a Jenkins custom resource that matches the users desired input."),(0,i.kt)("p",null,"Before going ahead and shipping this Promise its good to test it works first."),(0,i.kt)("h3",{id:"test-image"},"Test your pipeline image"),(0,i.kt)("p",null,"Test the Docker container image by supplying an input resource and examining the output resource."),(0,i.kt)("p",null,"You might of noticed earlier the ",(0,i.kt)("inlineCode",{parentName:"p"},"test-input")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"test-output")," directories inside the ",(0,i.kt)("inlineCode",{parentName:"p"},"request-pipeline-image/")," directory.\nWe can use these to test our pipeline works. Create a sample ",(0,i.kt)("inlineCode",{parentName:"p"},"object.yaml")," Resource Request in the ",(0,i.kt)("inlineCode",{parentName:"p"},"test-input/")," directory with the contents below"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="request-pipeline-image/test-input/object.yaml"',jsx:!0,title:'"request-pipeline-image/test-input/object.yaml"'},"apiVersion: example.promise.syntasso.io/v1\nkind: jenkins\nmetadata:\n  name: example-resource-request\nspec:\n  name: super-cool-name\n")),(0,i.kt)("p",null,"Run the container, providing this ",(0,i.kt)("inlineCode",{parentName:"p"},"test-input")," directory as the ",(0,i.kt)("inlineCode",{parentName:"p"},"/input/")," directory. We will also mount ",(0,i.kt)("inlineCode",{parentName:"p"},"/output")," to the ",(0,i.kt)("inlineCode",{parentName:"p"},"test-output")," directory."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker build --tag kratix-workshop/jenkins-request-pipeline:dev -f request-pipeline-image/Dockerfile request-pipeline-image\ndocker run -v ${PWD}/request-pipeline-image/test-input:/input -v ${PWD}/request-pipeline-image/test-output:/output kratix-workshop/jenkins-request-pipeline:dev\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"Verify the contents of the ",(0,i.kt)("inlineCode",{parentName:"p"},"request-pipeline-image/test-output"),"/ directory contains the desired ",(0,i.kt)("inlineCode",{parentName:"p"},"metadata.name"),"."),(0,i.kt)("h3",{id:"build-image"},"Build your pipeline image"),(0,i.kt)("p",null,"Once you are satisified that your pipeline is producing the expected result, load the Docker image to the local KinD cache:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kind load docker-image kratix-workshop/jenkins-request-pipeline:dev --name platform\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"The final step of creating the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasRequestPipeline")," is to reference your docker image from the ",(0,i.kt)("inlineCode",{parentName:"p"},"spec.xaasRequestPipeline")," field in the ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml"),"."),(0,i.kt)("p",null,"Add the image to the array in ",(0,i.kt)("inlineCode",{parentName:"p"},"promise.yaml"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jsx title="promise.yaml"',jsx:!0,title:'"promise.yaml"'},"apiVersion: platform.kratix.io/v1alpha1\nkind: Promise\nmetadata:\n  name: jenkins\nspec:\n  workerClusterResources:\n  xaasCrd:\n    ...\n  #highlight-start\n  xaasRequestPipeline:\n  - kratix-workshop/jenkins-request-pipeline:dev\n  #highlight-end\n")),(0,i.kt)("p",null,"In summary, you have:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Created a container image containing:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"A template file to be injected with per-instance details"),(0,i.kt)("li",{parentName:"ul"},"A shell script to retrieve the per-instance details from the user's request, and inject them into the template (",(0,i.kt)("inlineCode",{parentName:"li"},"execute-pipeline.sh"),")"))),(0,i.kt)("li",{parentName:"ul"},"Executed the pipeline image locally as a test"),(0,i.kt)("li",{parentName:"ul"},"Pushed the image to the registry"),(0,i.kt)("li",{parentName:"ul"},"Added the image to the Promise definition in the ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasRequestPipeline")," array")),(0,i.kt)("h3",{id:"install-promise"},"Install your Promise"),(0,i.kt)("p",null,"From your Promise directory, you can now install the Promise in Kratix."),(0,i.kt)("p",null,"At this point, your Promise directory structure should look like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\ud83d\udcc2 promise-template\n\u251c\u2500\u2500 \ud83d\udcc2 request-pipeline-image\n\u2502\xa0  \u251c\u2500\u2500 \ud83d\udcc2  test-input\n\u2502\xa0  \u2502\xa0  \u2514\u2500\u2500 object.yaml\n\u2502\xa0  \u251c\u2500\u2500 \ud83d\udcc2  test-output\n\u2502\xa0  \u2502\xa0  \u2514\u2500\u2500 jenkins_instance.yaml\n\u2502\xa0  \u251c\u2500\u2500 Dockerfile\n\u2502\xa0  \u251c\u2500\u2500 execute-pipeline.sh\n\u2502\xa0  \u2514\u2500\u2500 asset.yaml\n\u2514\u2500\u2500 promise.yaml\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"Before installing your promise, verify that Kratix and MinIO are installed and healthy."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context kind-platform get pods --namespace kratix-platform-system\n")),(0,i.kt)("p",null,"You should see something similar to"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"NAME                                                  READY   STATUS       RESTARTS   AGE\nkratix-platform-controller-manager-769855f9bb-8srtj   2/2     Running      0          1h\nminio-6f75d9fbcf-5cn7w                                1/1     Running      0          1h\n")),(0,i.kt)("p",null,"If that is not the case, please go back to ",(0,i.kt)("a",{parentName:"p",href:"using-multiple-promises#set-up"},"Part I")," and follow the instructions."),(0,i.kt)("p",null,"From the ",(0,i.kt)("inlineCode",{parentName:"p"},"promise-template")," directory, run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"kubectl apply --context kind-platform --filename promise.yaml\n")),(0,i.kt)("p",null,"Verify the Promise installed",(0,i.kt)("br",null),(0,i.kt)("sub",null,"(This may take a few minutes so ",(0,i.kt)("code",null,"--watch")," will watch the command. Press ",(0,i.kt)("kbd",null,"Ctrl"),"+",(0,i.kt)("kbd",null,"C")," to stop watching)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context kind-platform get crds --watch\n")),(0,i.kt)("p",null,"The above command will give an output similar to"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"NAME                                  CREATED AT\njenkins.example.promise.syntasso.io   2021-09-09T11:21:10Z\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"Verify the Jenkins Operator is running",(0,i.kt)("br",null),(0,i.kt)("sub",null,"(This may take a few minutes so ",(0,i.kt)("code",null,"--watch")," will watch the command. Press ",(0,i.kt)("kbd",null,"Ctrl"),"+",(0,i.kt)("kbd",null,"C")," to stop watching)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context kind-worker get pods --watch\n")),(0,i.kt)("p",null,"The above command will give an output similar to"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"NAME                                 READY   STATUS    RESTARTS   AGE\njenkins-operator-6c89d97d4f-r474w    1/1     Running   0          1m\n")),(0,i.kt)("h3",{id:"create-resource-request"},"Create and submit a Kratix Resource Request"),(0,i.kt)("p",null,"You can now request instances of Jenkins. Create a file in the called ",(0,i.kt)("inlineCode",{parentName:"p"},"jenkins-resource-request.yaml")," with the following content:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'jxs title="promise-template/jenkins-resource-request.yaml"',jxs:!0,title:'"promise-template/jenkins-resource-request.yaml"'},"apiVersion: example.promise.syntasso.io/v1\nkind: jenkins\nmetadata:\n  name: example-resource-request\nspec:\n  name: super-cool-name\n")),(0,i.kt)("p",null,"You can now send the resource request to Kratix:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply --context kind-platform --filename jenkins-resource-request.yaml\n")),(0,i.kt)("p",null,"Applying the Kratix Promise will trigger your pipeline steps which in turn requests an instance of Jenkins from the operator. While the pipeline can run quite quickly, Jenkins requires quite a few resources to be installed including a deployment and a runner which means the full install may take a few minutes."),(0,i.kt)("p",null,"You can see a bit of what is happening by first looking for your pipeline completion"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context kind-platform get pods\n")),(0,i.kt)("p",null,"This should result in something similar to"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"NAME                                             READY   STATUS      RESTARTS   AGE\nrequest-pipeline-jenkins-promise-default-9d40b   0/1     Completed   0          1m\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"For more details, you can view the pipeline logs with"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs \\\n  --context kind-platform \\\n  --selector kratix-promise-id=jenkins-default \\\n  --container xaas-request-pipeline-stage-1\n")),(0,i.kt)("p",null,"Then you can watch for the creation of your Jenkins instance by targeting the worker cluster:",(0,i.kt)("br",null),(0,i.kt)("sub",null,"(This may take a few minutes so ",(0,i.kt)("code",null,"--watch")," will watch the command. Press ",(0,i.kt)("kbd",null,"Ctrl"),"+",(0,i.kt)("kbd",null,"C")," to stop watching)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --context kind-worker get pods --all-namespaces --watch\n")),(0,i.kt)("p",null,"The above command will eventually give an output similar to"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"NAME                           READY   STATUS    RESTARTS   AGE\njenkins-super-cool-name        1/1     Running   0          1m\n...\n")),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"use-your-jenkins-instance"},"Use your Jenkins instance"),(0,i.kt)("p",null,"Access the Jenkins UI in a browser to ensure the instance is working."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Before you can access Jenkins UI, you must port forward from within the Kubernetes cluster to a local port on your computer. Running the ",(0,i.kt)("inlineCode",{parentName:"p"},"port-forward")," command is continuous","\u2014","as long as the command is running, the connection stays open."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("em",{parentName:"p"},(0,i.kt)("strong",{parentName:"em"},"Open a new terminal to request the port forward")),"."),(0,i.kt)("pre",{parentName:"admonition"},(0,i.kt)("code",{parentName:"pre",className:"language-console"},"kubectl --context kind-worker port-forward jenkins-super-cool-name 8080:8080\n"))),(0,i.kt)("p",null,"Navigate to ",(0,i.kt)("a",{parentName:"p",href:"http://localhost:8080"},"http://localhost:8080")," and log in with the credentials you get from the commands below.\nIn production, you want the credentials to be stored in a secure location where it could be accessed by the application team.\nIn this example, credentials are stored as unencrypted Kubernetes secrets."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console",metastring:'jsx title="username"',jsx:!0,title:'"username"'},"kubectl --context kind-worker get secret jenkins-operator-credentials-super-cool-name \\\n    -o 'jsonpath={.data.user}' | base64 -d\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console",metastring:'jsx title="password"',jsx:!0,title:'"password"'},"kubectl --context kind-worker get secret jenkins-operator-credentials-super-cool-name \\\n    -o 'jsonpath={.data.password}' | base64 -d\n")),(0,i.kt)("p",null,"Let's now take a look at what you have done in more details."),(0,i.kt)("h3",{id:"promise-review"},"Review of a Kratix Promise parts (in detail)"),(0,i.kt)("h4",{id:"xaascrd"},(0,i.kt)("inlineCode",{parentName:"h4"},"xaasCrd")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," is your user-facing API for the Promise. It defines the options that users can configure when they request the Promise. The complexity of the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasCrd")," API is up to you. You can read more about writing Custom Resource Definitions in the ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#create-a-customresourcedefinition"},"Kubernetes docs"),"."),(0,i.kt)("h4",{id:"workerclusterresources"},(0,i.kt)("inlineCode",{parentName:"h4"},"workerClusterResources")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," describes everything required to fulfil the Promise. Kratix applies this content on all registered worker clusters. For instance with the Jenkins Promise, the ",(0,i.kt)("inlineCode",{parentName:"p"},"workerClusterResources")," contains the Jenkins CRD, the Jenkins Operator, and the resources the Operator requires."),(0,i.kt)("h4",{id:"xaasrequestpipeline"},(0,i.kt)("inlineCode",{parentName:"h4"},"xaasRequestPipeline")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasRequestPipeline")," defines a set of jobs to run when Kratix receives a request for an instance of one of its Promises."),(0,i.kt)("p",null,"The pipeline is an array of Docker images, and those images are executed in order. The pipeline enables you to write Promises with specialised images and combine those images as needed."),(0,i.kt)("p",null,"Each container in the ",(0,i.kt)("inlineCode",{parentName:"p"},"xaasRequestPipeline")," array should output complete, valid Kubernetes resources."),(0,i.kt)("p",null,"The contract with each pipeline container is simple and straightforward:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The first container in the list receives the resource document created by the user's request","\u2014","this request will comply with the ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasCrd")," described above. The document is available to the pipeline in ",(0,i.kt)("inlineCode",{parentName:"li"},"/input/object.yaml"),"."),(0,i.kt)("li",{parentName:"ul"},"The container's command then executes with the input object and fulfils its responsibilites."),(0,i.kt)("li",{parentName:"ul"},"The container writes any resources to be created to ",(0,i.kt)("inlineCode",{parentName:"li"},"/output/"),"."),(0,i.kt)("li",{parentName:"ul"},"The resources in ",(0,i.kt)("inlineCode",{parentName:"li"},"/output")," of the last container in the ",(0,i.kt)("inlineCode",{parentName:"li"},"xaasRequestPipeline")," array will be scheduled and applied to the appropriate worker clusters.")),(0,i.kt)("h2",{id:"summary"},"Recap"),(0,i.kt)("p",null,"You have now authored your first promise. Congratulations \ud83c\udf89"),(0,i.kt)("h2",{id:"teardown"},"Tearing it all down"),(0,i.kt)("p",null,"To clean up your environment, run the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kind delete clusters platform worker\n")))}c.isMDXComponent=!0}}]);